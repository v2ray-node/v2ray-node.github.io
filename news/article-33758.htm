<!DOCTYPE html>
<html lang="zh-CN">

<head>
        <link rel="canonical" href="https://v2ray-node.github.io/news/article-33758.htm" />
    <title>React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式</title>
        <meta name="description" content="一、前言 先交代一下整个Demo项目结构：  一个认证服务（端口5000）IdentityServer4.Authentication 五个授权模式（两个控制台程序，三个MVC项目端口5001）文件夹" />
        <link rel="icon" href="/assets/website/img/v2ray_node/favicon.ico" type="image/x-icon"/>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,900" rel="stylesheet">
    <link rel="stylesheet" href="__ADDON__/fonts/v2ray_node/icomoon/style.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/jquery-ui.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/owl.carousel.min.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/owl.theme.default.min.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/owl.theme.default.min.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/jquery.fancybox.min.css">
    <link rel="stylesheet" href="__ADDON__/fonts/v2ray_node/flaticon/font/flaticon.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/aos.css">
    <link rel="stylesheet" href="/assets/website/css/v2ray_node/style.css">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7H6DT73WHK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7H6DT73WHK');
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3332997411212854"
     crossorigin="anonymous"></script>
</head>

<body data-spy="scroll" data-target=".site-navbar-target" data-offset="300" data-page="detail">
    <div class="site-wrap">
            
        <div class="site-mobile-menu site-navbar-target">
            <div class="site-mobile-menu-header">
                <div class="site-mobile-menu-close mt-3">
                    <span class="icon-close2 js-menu-toggle"></span>
                </div>
            </div>
            <div class="site-mobile-menu-body"></div>
        </div>
        <header class="site-navbar py-4 js-sticky-header site-navbar-target" role="banner">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-6 col-md-3">
                                                <span class="mb-0 site-logo"><a href="/" class="h2 mb-0"><span>V2ray Node</span> </a></span>
                                            </div>
                    <div class="col-12 col-md-9 d-none d-xl-block">
                        <nav class="site-navigation position-relative text-right" role="navigation">
                            <ul class="site-menu main-menu js-clone-nav mr-auto d-none d-lg-block">
                                                                <li><a href="/" class="nav-link">首页</a></li>
                                                                <li><a href="/free-nodes/" class="nav-link">免费节点</a></li>
                                                                <li><a href="/paid-subscribe/" class="nav-link">推荐机场</a></li>
                                                                <li><a href="/news/" class="nav-link">新闻资讯</a></li>
                                                                <li><a href="#" class="nav-link">关于</a></li>
                                <li><a href="#" class="nav-link">联系</a></li>
                            </ul>
                        </nav>
                    </div>
                    <div class="col-6 d-inline-block d-xl-none ml-md-0 py-3" style="position: relative; top: 3px;"><a href="#" class="site-menu-toggle js-menu-toggle text-black float-right"><span class="icon-menu h3"></span></a></div>
                </div>
            </div>
        </header>
        <div class="site-blocks-cover inner-page-cover overlay" style="background-image: url(__ADDON__/img/v2ray_node/hero_1.jpg);" data-aos="fade" id="home-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 mt-lg-5 mr-auto text-left align-self-end align-self-md-center">
                        <h1>React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式</h1>
                        <p><a href="/">首页</a> <span class="mx-3">&bullet;</span> <a href="/news/">新闻资讯</a> <span class="mx-3">&bullet;</span> 正文</p>
                    </div>
                </div>
            </div>
        </div>
        <section class="site-section" id="about-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-9">
                                        <input type="hidden" id="share-website-info" data-name="V2rayNode节点分享站" data-url="https://v2raynode.github.io">
                  				  				  				<h2 id="一前言">一、前言</h2> <p><strong>先交代一下整个Demo项目结构：</strong></p> <ul> <li><strong>一个认证服务（端口5000）</strong><code>IdentityServer4.Authentication</code></li> <li><strong>五个授权模式（两个控制台程序，三个MVC项目端口5001）文件夹</strong><code>GrantClient</code></li> <li><strong>两个资源服务（WebApi：UserApiResource端口8000，ProductApiResource端口9000）文件夹</strong><code>ApiResource</code></li> </ul> <p><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/db86f832f523f0e658f6f51e5e32d8a6.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h2 id="二准备认证服务--资源服务">二、准备认证服务 + 资源服务</h2> <h3 id="1认证服务">1、认证服务</h3> <p><strong>（1）新建一个MVC项目，安装 IdentityServer4 ，注册五种授权模式客户端，代码如下</strong></p> <pre><code class="language-C#">public class Startup {     public Startup(IConfiguration configuration)     {         Configuration = configuration;     }      public IConfiguration Configuration { get; }      // This method gets called by the runtime. Use this method to add services to the container.     public void ConfigureServices(IServiceCollection services)     {         services.AddControllersWithViews();          services.AddIdentityServer()         .AddDeveloperSigningCredential()                            //临时证书         .AddInMemoryClients(InMemoryConfig.GetClients())            //客户端模式，InMemory内存数据         .AddInMemoryApiScopes(InMemoryConfig.GetApiScopes())        //作用域         .AddInMemoryApiResources(InMemoryConfig.GetApiResources())  //资源         .AddTestUsers(InMemoryConfig.GetTestUser())                 //用户         .AddInMemoryIdentityResources(InMemoryConfig.IdentityResources);     }      // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.     public void Configure(IApplicationBuilder app, IWebHostEnvironment env)     {         if (env.IsDevelopment())         {             app.UseDeveloperExceptionPage();         }         else         {             app.UseExceptionHandler("/Home/Error");         }          app.UseIdentityServer(); //使用IdentityServer4          app.UseStaticFiles();          app.UseRouting();          app.UseAuthorization();          app.UseEndpoints(endpoints =&gt;         {             endpoints.MapControllerRoute(                 name: "default",                 pattern: "{controller=Home}/{action=Index}/{id?}");         });     } }</code></pre> <pre><code class="language-C#">public class InMemoryConfig {     public static IEnumerable&lt;IdentityResource&gt; IdentityResources =&gt;     new IdentityResource[]     {         new IdentityResources.OpenId(),         new IdentityResources.Profile(),         //new IdentityResources.Email(),         //new IdentityResources.Address(),         //new IdentityResources.Phone()     };     /// &lt;summary&gt;     /// ApiResource 资源列表     /// &lt;/summary&gt;     public static IEnumerable&lt;ApiResource&gt; GetApiResources()     {         return new[]         {             new ApiResource("UserApiResource", "获取用户信息API")             {                 Scopes={ "UserScope" }             },             new ApiResource("ProductApiResource", "获取商品信息API")             {                 Scopes={ "ProductScope" }             }         };     }     /// &lt;summary&gt;     /// ApiScopes 作用域     /// &lt;/summary&gt;     public static IEnumerable&lt;ApiScope&gt; GetApiScopes()     {         return new ApiScope[]         {             new ApiScope("UserScope"),             new ApiScope("ProductScope")         };     }     /// &lt;summary&gt;     /// Client 客户端     /// &lt;/summary&gt;     public static IEnumerable&lt;Client&gt; GetClients()     {         return new[]         {             //客户端模式             new Client             {                 ClientId = "ClientCredentials",                 ClientName = "ClientCredentials",                 ClientSecrets = new [] { new Secret("ClientCredentials".Sha256()) },                 AllowedGrantTypes = GrantTypes.ClientCredentials,                 AllowedScopes = new [] { "UserScope" }             },             //密码模式             new Client             {                 ClientId = "ResourceOwnerPasswordCredentials",                 ClientName = "ResourceOwnerPasswordCredentials",                 ClientSecrets = new [] { new Secret("ResourceOwnerPasswordCredentials".Sha256()) },                 AllowedGrantTypes = GrantTypes.ResourceOwnerPassword,                 AllowedScopes = new []                 {                     "ProductScope",                     IdentityServerConstants.StandardScopes.OpenId,                     IdentityServerConstants.StandardScopes.Profile,                 }             },             //简化模式             new Client             {                 ClientId = "Implicit",                 ClientName = "Implicit",                 AllowedGrantTypes = GrantTypes.Implicit,                 RedirectUris = { "https://localhost:5001/signin-oidc" },                 PostLogoutRedirectUris = { "https://localhost:5001/signout-callback-oidc" },                 RequireConsent = true,                 AllowedScopes = new []{                     "UserScope",                     "ProductScope",                     IdentityServerConstants.StandardScopes.OpenId,                     IdentityServerConstants.StandardScopes.Profile,                 }             },             //授权码模式             new Client             {                 ClientId = "AuthorizationCode",                 ClientName = "AuthorizationCode",                 ClientSecrets = new [] { new Secret("AuthorizationCode".Sha256()) },                 AllowedGrantTypes = GrantTypes.Code,                 RedirectUris = { "https://localhost:5001/signin-oidc" },                 PostLogoutRedirectUris = { "https://localhost:5001/signout-callback-oidc" },                 RequireConsent = true,                 AllowedScopes = new []{                     "UserScope",                     "ProductScope",                     IdentityServerConstants.StandardScopes.OpenId,                     IdentityServerConstants.StandardScopes.Profile,                 }             },             //混合模式             new Client             {                 ClientId = "Hybrid",                 ClientName = "Hybrid",                 ClientSecrets = new [] { new Secret("Hybrid".Sha256()) },                 AllowedGrantTypes = GrantTypes.Hybrid,                 RedirectUris = { "https://localhost:5001/signin-oidc" },                 PostLogoutRedirectUris = { "https://localhost:5001/signout-callback-oidc" },                 RequireConsent = true,                 RequirePkce = false,                 AllowedScopes = new []{                     "UserScope",                     "ProductScope",                     IdentityServerConstants.StandardScopes.OpenId,                     IdentityServerConstants.StandardScopes.Profile,                     //IdentityServerConstants.StandardScopes.Email,                     //IdentityServerConstants.StandardScopes.Address,                     //IdentityServerConstants.StandardScopes.Phone                 }             },         };     }     public static List&lt;TestUser&gt; GetTestUser()     {         return new List&lt;TestUser&gt;(){             new TestUser             {                 SubjectId = "1",                 Username = "WinterSir",                 Password = "WinterSir",                 Claims =                 {                      new Claim(JwtClaimTypes.Name,"WinterSir"),                      new Claim(JwtClaimTypes.GivenName,"WinterSir"),                      new Claim(JwtClaimTypes.FamilyName,"WinterSir-FamilyName"),                      new Claim(JwtClaimTypes.Email,"641187567@qq.com"),                      new Claim(JwtClaimTypes.EmailVerified,"true", ClaimValueTypes.Boolean),                      new Claim(JwtClaimTypes.WebSite,"http://WinterSir.com"),                      new Claim(JwtClaimTypes.Address,@" [ 'street_address': 'Chang Ping', 'locality': 'BeiJing' ,'postal_code’: 102206,'country': 'China'}",                      IdentityServerConstants.ClaimValueTypes.Json)                 }             }         };     } }</code></pre> <p><strong>（2）cmd</strong><code>dotnet new is4ui</code><strong>安装</strong><code>Quickstart UI</code><strong>模板，删除原来 Controllers 中 HomeController 防止冲突，设置5000端口启动</strong><br /><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/62605c634a743a0217c454e9b39dc921.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h3 id="2资源服务">2、资源服务</h3> <p><strong>新建两个WebApi项目，安装</strong><code>IdentityServer4.AccessTokenValidation</code><strong>，分别修改Startup、Controller，设置8000、9000端口启动</strong></p> <pre><code class="language-C#">public class Startup {     public Startup(IConfiguration configuration)     {         Configuration = configuration;     }      public IConfiguration Configuration { get; }      // This method gets called by the runtime. Use this method to add services to the container.     public void ConfigureServices(IServiceCollection services)     {          services.AddControllers();         services.AddSwaggerGen(c =&gt;         {             c.SwaggerDoc("v1", new OpenApiInfo { Title = "ProductApiResource", Version = "v1" });         });          //集成端口为5000的认证服务         services.AddAuthentication("Bearer")           .AddIdentityServerAuthentication(options =&gt;           {               options.Authority = "https://localhost:5000";               options.ApiName = "ProductApiResource";           });     }      // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.     public void Configure(IApplicationBuilder app, IWebHostEnvironment env)     {         if (env.IsDevelopment())         {             app.UseDeveloperExceptionPage();             app.UseSwagger();             app.UseSwaggerUI(c =&gt; c.SwaggerEndpoint("/swagger/v1/swagger.json", "ProductApiResource v1"));         }          app.UseRouting();          app.UseAuthentication();//鉴权          app.UseAuthorization();//授权          app.UseEndpoints(endpoints =&gt;         {             endpoints.MapControllers();         });     } }</code></pre> <p><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/6e59faf2f48569f953cd686d873612e2.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h2 id="三授权模式">三、授权模式</h2> <h3 id="1客户端授权模式">1、客户端授权模式</h3> <blockquote> <p><strong>客户端模式（Client Credentials）指客户端以自己的名义，而不是以用户的名义，向"认证服务"进行认证。如果是提前约束好的客户端，直接给你颁发令牌 token</strong></p> </blockquote> <p><strong>安装</strong><code>IdentityModel</code></p> <pre><code class="language-C#">class Program {     /// &lt;summary&gt;     /// 客户端模式（Client Credentials）     /// &lt;/summary&gt;     /// &lt;param name="args"&gt;&lt;/param&gt;     static void Main(string[] args)     {         Console.WriteLine("***************** 客户端模式（Client Credentials）*****************");         var client = new HttpClient();         var disco = client.GetDiscoveryDocumentAsync("https://localhost:5000/").Result;         if (disco.IsError)         {             Console.WriteLine(disco.Error);             return;         }         var tokenResponse = client.RequestClientCredentialsTokenAsync(new ClientCredentialsTokenRequest         {             Address = disco.TokenEndpoint,             ClientId = "ClientCredentials",             ClientSecret = "ClientCredentials",             Scope = "UserScope"         }).Result;          if (tokenResponse.IsError)         {             Console.WriteLine(tokenResponse.Error);             return;         }          Console.WriteLine("\nToken: " + tokenResponse.AccessToken);          var apiClient = new HttpClient();         apiClient.SetBearerToken(tokenResponse.AccessToken);         var response = apiClient.GetAsync("https://localhost:8000/User/Get").Result;         if (!response.IsSuccessStatusCode)         {             Console.WriteLine(response.StatusCode);         }         else         {             var content = response.Content.ReadAsStringAsync().Result;             Console.WriteLine("\n结果: " + content);         }          Console.ReadLine();     } }</code></pre> <p><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/abaf3a4c9fe02d4fd5d5e0621ee8a3ba.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h3 id="2密码模式">2、密码模式</h3> <blockquote> <p><strong>密码模式（Resource Owner Password Credentials）中客户端使用用户提供的用户名和密码，向"认证服务"进行认证，有较高风险，通常只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。相较于客户端多了一个用户角色。</strong></p> </blockquote> <p><strong>安装</strong><code>IdentityModel</code></p> <pre><code class="language-C#">static void Main(string[] args) {     Console.WriteLine("***************** 密码模式（Resource Owner Password credentials）***************** ");     var client = new HttpClient();     var disco = client.GetDiscoveryDocumentAsync("https://localhost:5000/").Result;     if (disco.IsError)     {         Console.WriteLine(disco.Error);         return;     }     var tokenResponse = client.RequestPasswordTokenAsync(new PasswordTokenRequest()     {         Address = disco.TokenEndpoint,         ClientId = "ResourceOwnerPasswordCredentials",         ClientSecret = "ResourceOwnerPasswordCredentials",         UserName = "WinterSir",         Password = "WinterSir",         Scope = "ProductScope",     }).Result;      if (tokenResponse.IsError)     {         Console.WriteLine(tokenResponse.Error);         return;     }      Console.WriteLine("\nToken: " + tokenResponse.AccessToken);      var apiClient = new HttpClient();     apiClient.SetBearerToken(tokenResponse.AccessToken);     var response = apiClient.GetAsync("https://localhost:9000/Product/Get").Result;     if (!response.IsSuccessStatusCode)     {         Console.WriteLine(response.StatusCode);     }     else     {         var content = response.Content.ReadAsStringAsync().Result;         Console.WriteLine("\n结果: " + content);     }      Console.ReadLine(); }</code></pre> <p><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/690b6ea480aafc8cb70668b1ccf8b1df.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h3 id="3简化模式">3、简化模式</h3> <blockquote> <p><strong>简化模式（Implicit）比授权码模式少了code环节，所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证，该模式是很不安全的，且不支持refresh token，适用于 Web 安全要求不高的场景，设置较短时效的 token。</strong></p> </blockquote> <p><strong>（1）安装</strong><code>IdentityServer4.AccessTokenValidation、Microsoft.AspNetCore.Authentication.OpenIdConnect</code><strong>，修改Startup</strong></p> <pre><code class="language-C#">public class Startup {     public Startup(IConfiguration configuration)     {         Configuration = configuration;     }      public IConfiguration Configuration { get; }      // This method gets called by the runtime. Use this method to add services to the container.     public void ConfigureServices(IServiceCollection services)     {         //关闭Jwt映射         JwtSecurityTokenHandler.DefaultMapInboundClaims = false;         //注册授权         services.AddAuthentication(options =&gt;         {             options.DefaultScheme = "Cookies";             options.DefaultChallengeScheme = "oidc";         })         .AddCookie("Cookies")         .AddOpenIdConnect("oidc", options =&gt;         {             options.Authority = "https://localhost:5000";       //认证服务             options.RequireHttpsMetadata = true;                //必须使用Https，否则用户无法登录             options.ClientId = "Implicit";             options.ClientSecret = "Implicit";             options.SaveTokens = true; //表示Token要存储         });          services.AddControllersWithViews().AddRazorRuntimeCompilation();     }      // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.     public void Configure(IApplicationBuilder app, IWebHostEnvironment env)     {         if (env.IsDevelopment())         {             app.UseDeveloperExceptionPage();         }         else         {             app.UseExceptionHandler("/Home/Error");         }         app.UseStaticFiles();          app.UseRouting();          app.UseAuthentication();          app.UseAuthorization();          app.UseHttpsRedirection();          app.UseEndpoints(endpoints =&gt;         {             endpoints.MapControllerRoute(                 name: "default",                 pattern: "{controller=Home}/{action=Index}/{id?}");         });     } }</code></pre> <p><strong>（2）_Layout.cshtml添加 注销按钮</strong></p> <pre><code class="language-html">&lt;div class="navbar-collapse collapse d-sm-inline-flex justify-content-between"&gt;     &lt;ul class="navbar-nav flex-grow-1"&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Index"&gt;Home&lt;/a&gt;         &lt;/li&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Privacy"&gt;Privacy&lt;/a&gt;         &lt;/li&gt;     &lt;/ul&gt;     &lt;a class="nav-link text-dark float-right" asp-area="" asp-controller="Home" asp-action="Logout"&gt;Logout&lt;/a&gt; &lt;/div&gt;</code></pre> <p><strong>（3）HomeController添加对应功能，需要认证的方法加上特性</strong><code>[Authorize]</code></p> <pre><code class="language-C#">[Authorize] public IActionResult Privacy() {     return View(); }  //注销 public IActionResult Logout() {     return SignOut("Cookies", "oidc"); }</code></pre> <p><strong>（4）修改Privacy.cshtml</strong></p> <pre><code class="language-HTML">@{     ViewData["Title"] = "Privacy Policy"; } &lt;h1&gt;@ViewData["Title"]&lt;/h1&gt;  @using Microsoft.AspNetCore.Authentication  &lt;h2&gt;Claims&lt;/h2&gt;  &lt;dl&gt;     @foreach (var claim in User.Claims)     {         &lt;dt&gt;@claim.Type&lt;/dt&gt;         &lt;dd&gt;@claim.Value&lt;/dd&gt;     } &lt;/dl&gt;  &lt;h2&gt;Properties&lt;/h2&gt;  &lt;dl&gt;     @foreach (var prop in (await Context.AuthenticateAsync()).Properties.Items)     {         &lt;dt&gt;@prop.Key&lt;/dt&gt;         &lt;dd&gt;@prop.Value&lt;/dd&gt;     } &lt;/dl&gt;</code></pre> <p><strong>（5）效果图</strong><br /><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/3e1cb408ec0748789dd66d3441538e65.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h3 id="4授权码模式">4、授权码模式</h3> <blockquote> <p><strong>授权码模式（Authorization Code）不同于简化模式直接返回token，而是先返回一个授权码，再用授权码去请求token，然后携带访问Api资源。授权码模式是功能最完整、流程最严密的授权模式。</strong></p> </blockquote> <p><strong>（1）安装</strong><code>IdentityServer4.AccessTokenValidation、Microsoft.AspNetCore.Authentication.OpenIdConnect</code><strong>，修改Startup</strong></p> <pre><code class="language-C#">public class Startup {     public Startup(IConfiguration configuration)     {         Configuration = configuration;     }      public IConfiguration Configuration { get; }      // This method gets called by the runtime. Use this method to add services to the container.     public void ConfigureServices(IServiceCollection services)     {         //关闭Jwt映射         JwtSecurityTokenHandler.DefaultMapInboundClaims = false;         //注册授权         services.AddAuthentication(options =&gt;         {             options.DefaultScheme = "Cookies";             options.DefaultChallengeScheme = "oidc";         })         .AddCookie("Cookies")         .AddOpenIdConnect("oidc", options =&gt;         {             options.Authority = "https://localhost:5000";       //认证服务             options.RequireHttpsMetadata = true;                //必须使用Https，否则用户无法登录             options.ClientId = "AuthorizationCode";             options.ClientSecret = "AuthorizationCode";             options.ResponseType = "code";             options.Scope.Clear();             options.Scope.Add("UserScope");             options.Scope.Add("ProductScope");             options.Scope.Add(OidcConstants.StandardScopes.OpenId);             options.Scope.Add(OidcConstants.StandardScopes.Profile);             //options.Scope.Add(OidcConstants.StandardScopes.Email);             //options.Scope.Add(OidcConstants.StandardScopes.Phone);             //options.Scope.Add(OidcConstants.StandardScopes.Address);             options.SaveTokens = true; //表示Token要存储         });          services.AddControllersWithViews().AddRazorRuntimeCompilation();         services.AddControllers().AddJsonOptions(options =&gt;         {             options.JsonSerializerOptions.Encoder = JavaScriptEncoder.Create(UnicodeRanges.All);         });     }      // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.     public void Configure(IApplicationBuilder app, IWebHostEnvironment env)     {         if (env.IsDevelopment())         {             app.UseDeveloperExceptionPage();         }         else         {             app.UseExceptionHandler("/Home/Error");         }         app.UseStaticFiles();          app.UseRouting();          app.UseAuthentication();          app.UseAuthorization();          app.UseHttpsRedirection();          app.UseEndpoints(endpoints =&gt;         {             endpoints.MapControllerRoute(                 name: "default",                 pattern: "{controller=Home}/{action=Index}/{id?}");         });     } }</code></pre> <p><strong>（2）_Layout.cshtml添加 获取用户按钮、注销按钮</strong></p> <pre><code class="language-HTML">&lt;div class="navbar-collapse collapse d-sm-inline-flex justify-content-between"&gt;     &lt;ul class="navbar-nav flex-grow-1"&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Index"&gt;Home&lt;/a&gt;         &lt;/li&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Privacy"&gt;Privacy&lt;/a&gt;         &lt;/li&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="User"&gt;UserApi&lt;/a&gt;         &lt;/li&gt;     &lt;/ul&gt;     &lt;a class="nav-link text-dark float-right" asp-area="" asp-controller="Home" asp-action="Logout"&gt;Logout&lt;/a&gt; &lt;/div&gt;</code></pre> <p><strong>（3）HomeController添加对应功能，需要认证的方法加上特性</strong><code>[Authorize]</code></p> <pre><code class="language-C#">[Authorize] public IActionResult Privacy() {     return View(); }  [Authorize] public async Task&lt;IActionResult&gt; User() {     var client = new HttpClient();     var accessToken = await HttpContext.GetTokenAsync(OpenIdConnectParameterNames.AccessToken);     if (string.IsNullOrEmpty(accessToken))     {         return Json(new { msg = "accesstoken 获取失败" });     }     client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);     var httpResponse = await client.GetAsync("https://localhost:8000/User/Get");     var result = await httpResponse.Content.ReadAsStringAsync();     if (!httpResponse.IsSuccessStatusCode)     {         ViewBag.Result = new { msg = "请求 User/Get 失败", error = result };     }     ViewBag.Result = new { msg = "成功", data = result };     return View(); }  //注销 public IActionResult Logout() {     return SignOut("Cookies", "oidc"); }</code></pre> <p><strong>（4）修改Privacy.cshtml</strong></p> <pre><code class="language-HTML">@{     ViewData["Title"] = "Privacy Policy"; } &lt;h1&gt;@ViewData["Title"]&lt;/h1&gt;  @using Microsoft.AspNetCore.Authentication  &lt;h2&gt;Claims&lt;/h2&gt;  &lt;dl&gt;     @foreach (var claim in User.Claims)     {         &lt;dt&gt;@claim.Type&lt;/dt&gt;         &lt;dd&gt;@claim.Value&lt;/dd&gt;     } &lt;/dl&gt;  &lt;h2&gt;Properties&lt;/h2&gt;  &lt;dl&gt;     @foreach (var prop in (await Context.AuthenticateAsync()).Properties.Items)     {         &lt;dt&gt;@prop.Key&lt;/dt&gt;         &lt;dd&gt;@prop.Value&lt;/dd&gt;     } &lt;/dl&gt;</code></pre> <p><strong>（5）效果图</strong><br /><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/1bcc4757cca29439733e63129163e119.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h3 id="5混合模式">5、混合模式</h3> <p><strong>混合模式（Hybrid Flow）</strong></p> <blockquote> <p>它为我们提供了两全其美的优势，身份令牌通过浏览器传输，因此客户端可以在进行任何更多工作之前对其进行验证。如果验证成功，客户端会通过令牌服务的以获取访问令牌</p> </blockquote> <p><strong>（1）安装</strong><code>IdentityServer4.AccessTokenValidation、Microsoft.AspNetCore.Authentication.OpenIdConnect</code><strong>，修改Startup</strong></p> <pre><code class="language-C#">public class Startup {     public Startup(IConfiguration configuration)     {         Configuration = configuration;     }      public IConfiguration Configuration { get; }      // This method gets called by the runtime. Use this method to add services to the container.     public void ConfigureServices(IServiceCollection services)     {         //关闭Jwt映射         JwtSecurityTokenHandler.DefaultMapInboundClaims = false;         //注册授权         services.AddAuthentication(options =&gt;         {             options.DefaultScheme = "Cookies";             options.DefaultChallengeScheme = "oidc";         })         .AddCookie("Cookies")         .AddOpenIdConnect("oidc", options =&gt;         {             options.Authority = "https://localhost:5000";       //认证服务             options.RequireHttpsMetadata = true;                //必须使用Https，否则用户无法登录             options.ClientId = "Hybrid";             options.ClientSecret = "Hybrid";             options.ResponseType = "code id_token";             options.Scope.Clear();             options.Scope.Add("UserScope");             options.Scope.Add("ProductScope");             options.Scope.Add(OidcConstants.StandardScopes.OpenId);             options.Scope.Add(OidcConstants.StandardScopes.Profile);             //options.Scope.Add(OidcConstants.StandardScopes.Email);             //options.Scope.Add(OidcConstants.StandardScopes.Phone);             //options.Scope.Add(OidcConstants.StandardScopes.Address);             //options.Scope.Add(OidcConstants.StandardScopes.0fflineAccess);//获取到刷新Token             options.SaveTokens = true; //表示Token要存储         });          services.AddControllersWithViews().AddRazorRuntimeCompilation();     }      // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.     public void Configure(IApplicationBuilder app, IWebHostEnvironment env)     {         if (env.IsDevelopment())         {             app.UseDeveloperExceptionPage();         }         else         {             app.UseExceptionHandler("/Home/Error");         }         app.UseStaticFiles();          app.UseRouting();          app.UseAuthentication();          app.UseAuthorization();          app.UseHttpsRedirection();          app.UseEndpoints(endpoints =&gt;         {             endpoints.MapControllerRoute(                 name: "default",                 pattern: "{controller=Home}/{action=Index}/{id?}");         });     } }</code></pre> <p><strong>（2）_Layout.cshtml添加 获取产品、注销按钮</strong></p> <pre><code class="language-HTML">&lt;div class="navbar-collapse collapse d-sm-inline-flex justify-content-between"&gt;     &lt;ul class="navbar-nav flex-grow-1"&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Index"&gt;Home&lt;/a&gt;         &lt;/li&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Privacy"&gt;Privacy&lt;/a&gt;         &lt;/li&gt;         &lt;li class="nav-item"&gt;             &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Product"&gt;ProductApi&lt;/a&gt;         &lt;/li&gt;     &lt;/ul&gt;     &lt;a class="nav-link text-dark float-right" asp-area="" asp-controller="Home" asp-action="Logout"&gt;Logout&lt;/a&gt; &lt;/div&gt;</code></pre> <p><strong>（3）HomeController添加对应功能，需要认证的方法加上特性</strong><code>[Authorize]</code></p> <pre><code class="language-C#">[Authorize] public IActionResult Privacy() {     return View(); } [Authorize] public async Task&lt;IActionResult&gt; Product() {     var client = new HttpClient();     var accessToken = await HttpContext.GetTokenAsync(OpenIdConnectParameterNames.AccessToken);     if (string.IsNullOrEmpty(accessToken))     {         return Json(new { msg = "accesstoken 获取失败" });     }     client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);     var httpResponse = await client.GetAsync("https://localhost:9000/Product/Get");     var result = await httpResponse.Content.ReadAsStringAsync();     if (!httpResponse.IsSuccessStatusCode)     {         ViewBag.Result = new { msg = "请求 User/Get 失败", error = result };     }     ViewBag.Result = new { msg = "成功", data = result };     return View(); }  //注销 public IActionResult Logout() {     return SignOut("Cookies", "oidc"); }</code></pre> <p><strong>（4）修改Privacy.cshtml</strong></p> <pre><code class="language-HTML">@{     ViewData["Title"] = "Privacy Policy"; } &lt;h1&gt;@ViewData["Title"]&lt;/h1&gt;  @using Microsoft.AspNetCore.Authentication  &lt;h2&gt;Claims&lt;/h2&gt;  &lt;dl&gt;     @foreach (var claim in User.Claims)     {         &lt;dt&gt;@claim.Type&lt;/dt&gt;         &lt;dd&gt;@claim.Value&lt;/dd&gt;     } &lt;/dl&gt;  &lt;h2&gt;Properties&lt;/h2&gt;  &lt;dl&gt;     @foreach (var prop in (await Context.AuthenticateAsync()).Properties.Items)     {         &lt;dt&gt;@prop.Key&lt;/dt&gt;         &lt;dd&gt;@prop.Value&lt;/dd&gt;     } &lt;/dl&gt;</code></pre> <p><strong>（5）效果图</strong><br /><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/f029bd6ff0f562b2c1707ac666b759b5.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h2 id="四问题踩坑">四、问题踩坑</h2> <h3 id="1https">1、Https</h3> <p><strong>Demo全部用的Https，Mvc客户端配置</strong><code>RequireHttpsMetadata = true</code><strong>如果使用http遇到认证服无法务登录问题，可参考以下地址</strong><br /><a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=https://www.cnblogs.com/i3yuan/p/14033016.html#autoid-20-0-0"  target="_blank" rel="nofollow">https://www.cnblogs.com/i3yuan/p/14033016.html#autoid-20-0-0</a></p> <h3 id="2responsetype">2、ResponseType</h3> <p><strong>授权码模式、混合模式需要修改客户端配置ResponseType，</strong><code>ResponseType = "code" 、 ResponseType = "code id_token"</code></p> <h3 id="3requirepkce">3、RequirePkce</h3> <p><strong>混合模式需要修改对应服务端注册客户端时配置</strong><code>RequirePkce = false</code><strong>，这样不需要客户端提供code challeng</strong><br /><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/10587f123d7e41d981598e2f68331ed8.jpg" alt="React Ant Design Pro + .Net5 WebApi：后端环境搭建-IdentityServer4（二）授权模式"></p> <h3 id="4其他error">4、其他Error</h3> <p><strong>出现错误大概率是客户端、服务端配置项问题，仔细对比一下就OK了</strong></p> <h2 id="五前人栽树后人乘凉">五、前人栽树，后人乘凉</h2> <p><a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=https://www.cnblogs.com/i3yuan/category/1777690.html"  target="_blank" rel="nofollow">https://www.cnblogs.com/i3yuan/category/1777690.html</a></p> <h2 id="六代码已上传">六、代码已上传</h2> <p><a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=https://github.com/WinterSir/IdentityServer4.GrantTypesDemo"  target="_blank" rel="nofollow">https://github.com/WinterSir/IdentityServer4.GrantTypesDemo</a></p> 			                <div class="clearfix"></div>
                <div class="col-md-12 mt-5">
                                        <p>上一个：<a href="/news/article-33274.htm">1970年4月22日出生是什么命（1970年4月18日出生是什么命）</a></p>
                                        <p>下一个：<a href="/news/article-33759.htm">宠物粮食市场规模多大啊（宠物粮市场份额）</a></p>
                                    </div>
                                    </div>
                    <div class="col-md-3">
                        <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">热门文章</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2"><a href="/news/article-21591.htm" title="义乌哪里有领养中心 义乌哪里有领养中心啊">义乌哪里有领养中心 义乌哪里有领养中心啊</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-9-22-free-v2ray-subscribe.htm" title="「9月22日」最高速度19.1M/S，2024年SSR/V2ray/Shadowrocket/Clash每天更新免费节点订阅链接">「9月22日」最高速度19.1M/S，2024年SSR/V2ray/Shadowrocket/Clash每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-12-30-free-node-subscribe-links.htm" title="「12月30日」最高速度21.4M/S，2024年SSR/Clash/Shadowrocket/V2ray每天更新免费节点订阅链接">「12月30日」最高速度21.4M/S，2024年SSR/Clash/Shadowrocket/V2ray每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-11-25-free-subscribe-node.htm" title="「11月25日」最高速度20.6M/S，2024年Clash/V2ray/Shadowrocket/SSR每天更新免费节点订阅链接">「11月25日」最高速度20.6M/S，2024年Clash/V2ray/Shadowrocket/SSR每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-12-2-free-v2ray.htm" title="「12月2日」最高速度18.4M/S，2024年Shadowrocket/Clash/V2ray/SSR每天更新免费节点订阅链接">「12月2日」最高速度18.4M/S，2024年Shadowrocket/Clash/V2ray/SSR每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-11-1-free-node-subscribe.htm" title="「11月1日」最高速度18.3M/S，2024年Shadowrocket/SSR/Clash/V2ray每天更新免费节点订阅链接">「11月1日」最高速度18.3M/S，2024年Shadowrocket/SSR/Clash/V2ray每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-9-17-free-v2ray-subscribe.htm" title="「9月17日」最高速度21.8M/S，2024年V2ray/Clash/Shadowrocket/SSR每天更新免费节点订阅链接">「9月17日」最高速度21.8M/S，2024年V2ray/Clash/Shadowrocket/SSR每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/news/article-26671.htm" title="宠物粮食店名称大全四个字怎么取（宠物粮创意名字）">宠物粮食店名称大全四个字怎么取（宠物粮创意名字）</a></li>
                        <li class="py-2"><a href="/news/article-30422.htm" title="同城免费领养宠物诈骗电话 同城免费领养宠物诈骗电话号码">同城免费领养宠物诈骗电话 同城免费领养宠物诈骗电话号码</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-9-18-free-high-speed-nodes.htm" title="「9月18日」最高速度21.8M/S，2024年SSR/V2ray/Clash/Shadowrocket每天更新免费节点订阅链接">「9月18日」最高速度21.8M/S，2024年SSR/V2ray/Clash/Shadowrocket每天更新免费节点订阅链接</a></li>
                    </ul>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">归纳</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">3</span> <a href="/date/2025-01/" title="2025-01 归档">2025-01</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">93</span> <a href="/date/2024-12/" title="2024-12 归档">2024-12</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">34</span> <a href="/date/2024-11/" title="2024-11 归档">2024-11</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">31</span> <a href="/date/2024-10/" title="2024-10 归档">2024-10</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">30</span> <a href="/date/2024-09/" title="2024-09 归档">2024-09</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">22</span> <a href="/date/2024-08/" title="2024-08 归档">2024-08</a></h4>
            </li>
                    </ul>
    </div>
</div>

                    </div>
                </div>
            </div>
        </section>
                <footer class="site-footer">
            <div class="container">
                <div class="row text-center">
                    <div class="col-md-12">
                        <div class="border-top">
                    <p>
                        <a href="/">首页</a> | 
                        <a href="/free-node/">免费节点</a> | 
                        <a href="/news/">新闻资讯</a> |
                        <a href="/about-us.htm">关于我们</a> |
                        <a href="/disclaimer.htm">免责申明</a> |
                        <a href="/privacy.htm">隐私申明</a> |
                        <a href="/sitemap.xml">网站地图</a>
                    </p>
                            <p>
                                <a href="/">V2ray Node免费节点官网</a> 版权所有 Powered by WordPress
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
      <script src="/assets/website/js/frontend/v2ray_node/jquery-3.3.1.min.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/jquery-migrate-3.0.1.min.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/jquery-ui.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/popper.min.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/bootstrap.min.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/owl.carousel.min.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/jquery.stellar.min.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/jquery.easing.1.3.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/aos.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/jquery.fancybox.min.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/jquery.sticky.js"></script>
      <script src="/assets/website/js/frontend/v2ray_node/main.js"></script>
      <script src="https://www.freeclashnode.com/assets/js/frontend/invite-url.js"></script>
      <script src="/assets/website/js/frontend/G.js"></script>
    </div> <!-- .site-wrap -->
</body>

</html>